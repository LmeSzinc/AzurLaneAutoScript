name: Sync Upstream

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Fetch upstream
        run: |
          git remote add upstream https://github.com/LmeSzinc/AzurLaneAutoScript.git || true
          git fetch upstream master

      - name: Create sync branch from master
        run: |
          git checkout -B codex/sync-upstream-auto origin/master

      - name: Merge upstream master
        run: |
          git merge --no-ff --no-edit upstream/master

      - name: Push sync branch
        run: |
          git push origin codex/sync-upstream-auto --force-with-lease

      - name: Create or update PR
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const base = "master";
            const branch = "codex/sync-upstream-auto";

            const cmp = await github.rest.repos.compareCommitsWithBasehead({
              owner,
              repo,
              basehead: `${base}...${branch}`,
            });

            if (cmp.data.ahead_by === 0) {
              core.info("No upstream changes to sync. Skip PR.");
              return;
            }

            const head = `${owner}:${branch}`;
            const title = "chore: sync upstream master";
            const body = [
              "Auto-sync from `upstream/master` to fork `master`.",
              "This PR is generated by `.github/workflows/sync-upstream.yml`.",
            ].join("\n");

            const prs = await github.rest.pulls.list({
              owner,
              repo,
              state: "open",
              head,
              base,
              per_page: 10,
            });

            if (prs.data.length > 0) {
              const pr = prs.data[0];
              await github.rest.pulls.update({
                owner,
                repo,
                pull_number: pr.number,
                title,
                body,
              });
              core.info(`Updated PR #${pr.number}`);
            } else {
              const pr = await github.rest.pulls.create({
                owner,
                repo,
                head: branch,
                base,
                title,
                body,
              });
              core.info(`Created PR #${pr.data.number}`);
            }
